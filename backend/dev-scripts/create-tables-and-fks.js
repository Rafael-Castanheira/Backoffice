const db = require('../models');
const Sequelize = db.Sequelize;

async function run() {
  const qi = db.sequelize.getQueryInterface();
  const models = Object.keys(db).filter(k => k !== 'sequelize' && k !== 'Sequelize');

  console.log('Model list:', models.join(', '));

  // Create all tables without FK references
  for (const k of models) {
    const model = db[k];
    const tableName = model.getTableName();
    try {
      await qi.describeTable(tableName);
      console.log('Table exists:', tableName);
      continue;
    } catch (e) {
      // Table does not exist â€” create
    }

    const attrs = {};
    for (const [colName, attr] of Object.entries(model.rawAttributes)) {
      const clone = { ...attr };
      // Remove references to avoid FK creation at this stage
      if (clone.references) delete clone.references;
      // Remove auto-created properties that queryInterface might not expect
      delete clone._autoGenerated;
      delete clone.field;
      attrs[colName] = clone;
    }

    console.log('Creating table (no FKs):', tableName);
    await qi.createTable(tableName, attrs);
  }

  // Add foreign key constraints now (after all tables exist)
  for (const k of models) {
    const model = db[k];
    const tableName = model.getTableName();
    for (const [colName, attr] of Object.entries(model.rawAttributes)) {
      if (!attr.references) continue;
      const refTable = attr.references.model;
      const refField = attr.references.key || attr.references.field || Object.values(attr.references)[0];
      const onUpdate = attr.onUpdate || 'CASCADE';
      const onDelete = attr.onDelete || 'SET NULL';

      // skip if constraint already exists
      try {
        // Add constraint with a generated name
        const constraintName = `fk_${tableName}_${colName}`;
        console.log(`Adding FK ${constraintName}: ${tableName}.${colName} -> ${refTable}.${refField}`);
        await qi.addConstraint(tableName, {
          fields: [colName],
          type: 'foreign key',
          name: constraintName,
          references: { table: refTable, field: refField },
          onDelete,
          onUpdate,
        });
      } catch (err) {
        console.error('Constraint add failed (maybe exists):', err.message || err);
      }
    }
  }
}

run().then(()=>{
  console.log('âœ… Dev create done');
  process.exit(0);
}).catch(err=>{console.error('ðŸ”´ Error:', err); process.exit(1)})
